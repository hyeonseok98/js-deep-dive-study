# [23장] 실행 컨텍스트

> 실행 컨텍스트는 자바스크립트의 동작 원리를 이해할 수 있는 개념이다!

## ✨ 23.1 소스코드의 타입

| 소스코드의 타입 | 설명                                                                    |
| --------------- | ----------------------------------------------------------------------- |
| 전역코드        | 전역에 존재하는 소스코드, 함수나 클래스 내부의 코드는 제외              |
| 함수 코드       | 함수 내부에 존재하는 코드, 중첩 함수나 클래스 내부 코드는 제외          |
| eval 코드       | 빌트인 전역 함수인 eval 함수에 인수로 전달되어 실행되는 소스코드        |
| 모듈 코드       | 모듈 내부의 소스코드, 모듈 내부에 정의된 함수나 클래스 내부 코드는 제외 |

이 네 가지 종류의 소스코드는 실행 컨텍스트를 생성한다.

1. 전역 코드

   - 전역 변수를 관리하기 위해 전역 스코프를 갖는다

2. 함수 코드

   - 함수 만의 지역 스코프를 생성한다. 이 스코프에서 지역 변수, 매개변수와 같은 arguments 객체를 관리한다. 또한, 전역 코드의 실행 컨텍스트와 스코프 체인으로 연결한다.

3. eval 코드

   - eval 코드는 strict mode(엄격 모드)에서 독립적인 스코프를 갖는다.

4. 모듈 코드
   - 모듈 별로 독립적인 스코프를 갖는다. 이를 위해 모듈 실행 컨텍스트가 생성된다.

## ✨ 23.2 소스코드의 평가와 실행

앞서 살펴본 소스코드들은 실행되기 전 '평가' 단계를 거친 뒤 '실행'된다.
먼저, 평가 과정에서는 실행 컨텍스트를 생성하고 변수 그리고 함수 선언문을 먼저 실행 컨텍스트의 스코프에 등록한다.

평가 이후, 소스코드의 실행이 시작된다. 이 때, 앞서 실행 컨텍스트에 담긴 정보인 스코프를 통해 필요한 변수나 함수 또는 객체를 참조하게 된다.
코드 실행 후의 결과 또한 실행 컨텍스트에 반영된다!

```javascript
var x;
x = 1;
```

위 코드를 실행한다고 가정해보자.

![소스코드의 평가](./img/sourcecodeeval.png)

먼저, 소스코드 평가 과정에서 호이스팅이 일어나고 `var` 키워드로 선언한 변수 `x` 는 런타임 이전에 `undefined` 로 초기화 된다.

이후 실행 과정에서 `x` 에 `1`이 할당 된다.

![소스코드의 실행](./img/sourcecodeexecute.png)

## ✨ 23.3 실행 컨텍스트의 역할

```javascript
const x = 1;
const y = 2;

function foo(a) {
  const x = 10;
  const y = 20;

  console.log(a + x + y); // 130
}

foo(100);

console.log(x + y); // 3
```

위 예시는, 전역 환경에서 변수와 함수 선언문을 정의한 상황이다.
코드의 평가와 실행이 이루어지는 과정을 살펴보자.

1. 전역 코드 평가

   - 코드 평가 시에는, 변수 선언문과 함수 선언문만 먼저 평가되어 실행 컨텍스트의 전역 스코프에 등록된다.

2. 전역 코드 실행

   - 전역 코드 평가 과정이 끝나면, 런타임에서 실행 컨텍스트의 정보를 가지고 코드 실행이 이루어진다.

3. 함수 코드 평가

   - 함수 내부에 정의된 것들의 평가가 이루어 진다. arguments 객체도 이때 생성되며 실행 컨텍스트의 지역 스코프에 등록된다.

4. 함수 코드 실행
   - 함수 내부의 코드의 평가가 끝난 후, 실행이 된다.
   - 함수 내부에서 `console.log()` 를 실행하기 위해서 스코프 체인을 통해 검색한 뒤 `(a+x+y)` 식이 평가 된다. 이후 콘솔에 값을 출력한 뒤 함수가 종료된다.
   - 함수 종료 후에는 호출 이전의 상태로 다시 돌아가 전역 공간의 코드를 실행한다.

함수가 종료된 뒤, 이전 상태로 돌아가려면 실행 컨텍스트 내에 변수나 함수의 식별자 정보, 스코프, 코드 실행 순서까지도 담고 있어야 한다.

식별자와 스코프 정보는 **렉시컬 환경**, 코드 실행 순서는 **실행 컨텍스트 스택**을 통해 관리한다!

## ✨ 23.4 실행 컨텍스트 스택

```javascript
const x = 1;

function foo() {
  const y = 2;

  function bar() {
    const z = 3;
    console.log(x + y + z);
  }

  bar();
}

foo(); // 6
```

위 예시 코드 또한 전역 코드와 함수 코드로 이루어져있다.

코드 실행 순서에 따라, 실행 컨텍스트가 추가 / 삭제 되며 스택 구조로 관리된다.

![실행 컨텍스트 스택](./img/context.png)

자세한 코드 실행 순서는 아래와 같다.

1. 전역 코드의 평가와 실행

   - 전역 변수 `x` 와 전역 함수 `foo()` 는 전역 스코프로 실행 컨텍스트에 등록된다.

2. foo 함수 코드의 평가와 실행

   - 전역 함수 `foo()` 가 호출 되면 전역 코드의 실행은 일시 중단 되고, 코드의 제어권은 `foo()` 함수로 이동한다. 이때 함수 내부의 코드가 평가 되며 실행 컨텍스트 스택에 추가 된다. 이후 코드 실행이 되며 `bar()` 의 실행이 이루어진다.

3. bar 함수 코드의 평가와 실행

   - 중첩 함수 `bar()` 또한 호출 되면 내부의 코드가 평가되면서 제어권이 `bar()` 로 이동한다. 마찬가지로 실행 컨텍스트 스택에 추가되고 내부 코드 실행이 된다.

4. foo 함수 코드로 복귀

   - `bar()` 함수가 종료되면서 실행 컨텍스트 스택에서 `bar()` 가 사라진다. 그 다음, 스택에 `foo()` 가 여전히 남아있기에 복귀하게 되지만 `foo()` 역시 모든 내부 코드를 실행했기에 종료된다.

5. 전역 코드로 복귀
   - `foo()` 가 실행 컨텍스트 스택에서 사라지고, 스택의 최하단인 전역 공간으로 복귀한다. 하지만 모든 코드가 실행되었기에 실행 컨텍스트 스택에는 아무것도 남아있지 않게 된다.

## ✨ 23.5 렉시컬 환경

렉시컬 환경(Lexical Environment)은 식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조가 가능하도록 정보를 가지는 요소다.
